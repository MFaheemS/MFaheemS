name: Update Streak

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-streak:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Debug - Print environment info
        run: |
          echo "=== Workflow Execution Info ==="
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "GitHub User: MFaheemS"
          echo "Event: ${{ github.event_name }}"
          echo "================================"
      
      - name: Fetch all repositories
        id: fetch-repos
        run: |
          echo "=== Fetching All Repositories for MFaheemS ==="
          
          # Fetch all repos (paginated)
          PAGE=1
          ALL_REPOS="[]"
          
          while true; do
            echo "Fetching page $PAGE..."
            REPOS=$(curl -s "https://api.github.com/users/MFaheemS/repos?per_page=100&page=$PAGE&type=all" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json")
            
            # Check if we got any repos
            REPO_COUNT=$(echo "$REPOS" | jq 'length')
            
            if [ "$REPO_COUNT" -eq 0 ]; then
              break
            fi
            
            # Merge with existing repos
            ALL_REPOS=$(echo "$ALL_REPOS" "$REPOS" | jq -s '.[0] + .[1]')
            
            echo "Retrieved $REPO_COUNT repos from page $PAGE"
            PAGE=$((PAGE + 1))
            
            # Safety limit
            if [ $PAGE -gt 10 ]; then
              break
            fi
          done
          
          # Save all repos
          echo "$ALL_REPOS" > all_repos.json
          
          TOTAL_REPOS=$(echo "$ALL_REPOS" | jq 'length')
          echo "total_repos=$TOTAL_REPOS" >> $GITHUB_OUTPUT
          echo "âœ… Total repositories found: $TOTAL_REPOS"
      
      - name: Fetch commit activity from all repos
        id: fetch-commits
        run: |
          echo "=== Fetching Commit Activity Across All Repos ==="
          
          TOTAL_REPOS=${{ steps.fetch-repos.outputs.total_repos }}
          echo "Processing $TOTAL_REPOS repositories..."
          
          # Initialize commit dates file
          > all_commit_dates.txt
          
          TOTAL_COMMITS=0
          PROCESSED=0
          
          # Process each repository
          while IFS= read -r repo; do
            REPO_NAME=$(echo "$repo" | jq -r '.full_name')
            PROCESSED=$((PROCESSED + 1))
            
            echo "[$PROCESSED/$TOTAL_REPOS] Processing: $REPO_NAME"
            
            # Fetch commits for this repo (last 1000 commits, paginated)
            PAGE=1
            while [ $PAGE -le 10 ]; do
              COMMITS=$(curl -s "https://api.github.com/repos/$REPO_NAME/commits?author=MFaheemS&per_page=100&page=$PAGE" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" 2>/dev/null)
              
              # Check if we got valid JSON
              if ! echo "$COMMITS" | jq empty 2>/dev/null; then
                echo "  âš ï¸  Skipping (no access or empty)"
                break
              fi
              
              COMMIT_COUNT=$(echo "$COMMITS" | jq 'length')
              
              if [ "$COMMIT_COUNT" -eq 0 ]; then
                break
              fi
              
              # Extract commit dates (YYYY-MM-DD format)
              echo "$COMMITS" | jq -r '.[].commit.author.date' | cut -d'T' -f1 >> all_commit_dates.txt
              
              TOTAL_COMMITS=$((TOTAL_COMMITS + COMMIT_COUNT))
              echo "  âœ“ Found $COMMIT_COUNT commits (page $PAGE)"
              
              PAGE=$((PAGE + 1))
              
              # Rate limiting protection
              sleep 0.5
            done
          done < <(jq -c '.[]' all_repos.json)
          
          # Sort and deduplicate dates
          sort -u all_commit_dates.txt -o commit_dates_unique.txt
          
          UNIQUE_DAYS=$(wc -l < commit_dates_unique.txt)
          
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "unique_days=$UNIQUE_DAYS" >> $GITHUB_OUTPUT
          
          echo "=============================="
          echo "âœ… Total commits found: $TOTAL_COMMITS"
          echo "âœ… Unique days with commits: $UNIQUE_DAYS"
          echo "=============================="
      
      - name: Calculate streak statistics
        id: calculate-streak
        run: |
          echo "=== Calculating Streak Statistics ==="
          
          TOTAL_COMMITS=${{ steps.fetch-commits.outputs.total_commits }}
          
          # Calculate current streak (consecutive days from today backwards)
          CURRENT_STREAK=0
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          
          echo "Checking for commits starting from: $CURRENT_DATE"
          
          while true; do
            if grep -q "^$CURRENT_DATE$" commit_dates_unique.txt 2>/dev/null; then
              CURRENT_STREAK=$((CURRENT_STREAK + 1))
              echo "  âœ“ Day $CURRENT_STREAK: $CURRENT_DATE"
              CURRENT_DATE=$(date -u -d "$CURRENT_DATE -1 day" +%Y-%m-%d 2>/dev/null || date -u -v-1d -j -f "%Y-%m-%d" "$CURRENT_DATE" +%Y-%m-%d 2>/dev/null)
            else
              echo "  âœ— Streak ends (no commit on $CURRENT_DATE)"
              break
            fi
            
            # Safety limit
            if [ $CURRENT_STREAK -gt 1000 ]; then
              break
            fi
          done
          
          # Calculate longest streak
          echo "Calculating longest streak..."
          
          LONGEST_STREAK=0
          TEMP_STREAK=0
          PREV_DATE=""
          
          while IFS= read -r commit_date; do
            if [ -z "$PREV_DATE" ]; then
              TEMP_STREAK=1
            else
              # Calculate days difference
              DATE1_EPOCH=$(date -u -d "$PREV_DATE" +%s 2>/dev/null || date -u -j -f "%Y-%m-%d" "$PREV_DATE" +%s)
              DATE2_EPOCH=$(date -u -d "$commit_date" +%s 2>/dev/null || date -u -j -f "%Y-%m-%d" "$commit_date" +%s)
              DAYS_DIFF=$(( (DATE2_EPOCH - DATE1_EPOCH) / 86400 ))
              
              if [ $DAYS_DIFF -eq 1 ]; then
                TEMP_STREAK=$((TEMP_STREAK + 1))
              else
                TEMP_STREAK=1
              fi
            fi
            
            if [ $TEMP_STREAK -gt $LONGEST_STREAK ]; then
              LONGEST_STREAK=$TEMP_STREAK
            fi
            
            PREV_DATE=$commit_date
          done < commit_dates_unique.txt
          
          echo "current_streak=$CURRENT_STREAK" >> $GITHUB_OUTPUT
          echo "longest_streak=$LONGEST_STREAK" >> $GITHUB_OUTPUT
          echo "total_contributions=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          
          echo "=============================="
          echo "ğŸ“Š FINAL STATISTICS:"
          echo "ğŸ”¥ Current Streak: $CURRENT_STREAK days"
          echo "ğŸ† Longest Streak: $LONGEST_STREAK days"
          echo "ğŸ“ˆ Total Contributions: $TOTAL_COMMITS commits"
          echo "=============================="
      
      - name: Update SVG file
        run: |
          CURRENT_STREAK=${{ steps.calculate-streak.outputs.current_streak }}
          LONGEST_STREAK=${{ steps.calculate-streak.outputs.longest_streak }}
          TOTAL_CONTRIBUTIONS=${{ steps.calculate-streak.outputs.total_contributions }}
          
          echo "=== Updating SVG for MFaheemS ==="
          echo "Current Streak: $CURRENT_STREAK days"
          echo "Longest Streak: $LONGEST_STREAK days"
          echo "Total Contributions: $TOTAL_CONTRIBUTIONS commits"
          
          # Determine streak emoji and message based on current streak
          if [ $CURRENT_STREAK -eq 0 ]; then
            STREAK_EMOJI="ğŸ’¤"
            STREAK_MESSAGE="Start your streak today!"
          elif [ $CURRENT_STREAK -lt 7 ]; then
            STREAK_EMOJI="ğŸ”¥"
            STREAK_MESSAGE="Keep it going!"
          elif [ $CURRENT_STREAK -lt 30 ]; then
            STREAK_EMOJI="âš¡"
            STREAK_MESSAGE="You're on fire!"
          elif [ $CURRENT_STREAK -lt 100 ]; then
            STREAK_EMOJI="ğŸŒŸ"
            STREAK_MESSAGE="Amazing streak!"
          elif [ $CURRENT_STREAK -lt 365 ]; then
            STREAK_EMOJI="ğŸ‘‘"
            STREAK_MESSAGE="Legendary streak!"
          else
            STREAK_EMOJI="ğŸš€"
            STREAK_MESSAGE="Unstoppable force!"
          fi
          
          # Update the SVG file
          cat > streak.svg << EOF
          <svg width="495" height="195" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#1a1b27;stop-opacity:1"/>
                <stop offset="100%" style="stop-color:#2d1b69;stop-opacity:1"/>
              </linearGradient>
            </defs>
            <rect width="495" height="195" rx="10" fill="url(#grad1)"/>
            <rect width="495" height="195" rx="10" fill="none" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="247.5" y="30" font-family="Segoe UI,Arial,sans-serif" font-size="18" font-weight="bold" fill="#70a5fd" text-anchor="middle">MFaheemS's GitHub Contribution Streak</text>
            <text x="247.5" y="55" font-family="Segoe UI,Arial,sans-serif" font-size="12" fill="#9ca3af" text-anchor="middle">$STREAK_MESSAGE</text>
            <line x1="40" y1="70" x2="455" y2="70" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="80" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#70a5fd" text-anchor="middle">$CURRENT_STREAK</text>
            <text x="80" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Current Streak</text>
            <text x="80" y="160" font-family="Arial" font-size="24" text-anchor="middle">$STREAK_EMOJI</text>
            <line x1="165" y1="85" x2="165" y2="175" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="247.5" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#a78bfa" text-anchor="middle">$LONGEST_STREAK</text>
            <text x="247.5" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Longest Streak</text>
            <text x="247.5" y="160" font-family="Arial" font-size="24" text-anchor="middle">ğŸ†</text>
            <line x1="330" y1="85" x2="330" y2="175" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="415" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#34d399" text-anchor="middle">$TOTAL_CONTRIBUTIONS</text>
            <text x="415" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Total Contributions</text>
            <text x="415" y="160" font-family="Arial" font-size="24" text-anchor="middle">ğŸ“Š</text>
          </svg>
          EOF
          
          echo "âœ… SVG file updated successfully"
      
      - name: Debug - Check for changes
        run: |
          echo "=== Git Status ==="
          git status
          echo "=================="
          
          if git diff --quiet; then
            echo "âš ï¸  No changes detected"
          else
            echo "âœ… Changes detected in streak.svg"
          fi
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "=== Committing Changes ==="
            git add streak.svg
            git commit -m "chore: update GitHub-wide streak data for MFaheemS [skip ci]" || true
            
            echo "Attempting to push changes..."
            git push origin main || git push origin master || {
              echo "Push failed, retrying with pull first..."
              git pull origin main --rebase || git pull origin master --rebase
              git push origin main || git push origin master
            }
            echo "âœ… Changes pushed successfully"
          else
            echo "â„¹ï¸  No changes to commit"
          fi
      
      - name: Final Summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   GitHub Streak Update Complete! ğŸ‰   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“… Completed: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ User: MFaheemS"
          echo "ğŸ“¦ Repositories: ${{ steps.fetch-repos.outputs.total_repos }}"
          echo "ğŸ”¥ Current Streak: ${{ steps.calculate-streak.outputs.current_streak }} days"
          echo "ğŸ† Longest Streak: ${{ steps.calculate-streak.outputs.longest_streak }} days"
          echo "ğŸ“ˆ Total Commits: ${{ steps.calculate-streak.outputs.total_contributions }}"
          echo ""
          echo "Next update: In 1 hour (or manual trigger)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
