name: Update Streak

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-streak:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Debug - Print environment info
        run: |
          echo "=== Workflow Execution Info ==="
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "GitHub User: MFaheemS"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "================================"
      
      - name: Fetch GitHub contribution data
        id: github-data
        run: |
          echo "=== Fetching GitHub Data for MFaheemS ==="
          
          # Fetch user data
          curl -s "https://api.github.com/users/MFaheemS" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            > user_data.json
          
          echo "User data fetched successfully"
          
          # Fetch all repositories
          curl -s "https://api.github.com/users/MFaheemS/repos?per_page=100&type=all" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            > repos.json
          
          REPO_COUNT=$(jq 'length' repos.json)
          echo "Repository count: $REPO_COUNT"
          
          # Get total public repos from user data
          PUBLIC_REPOS=$(jq '.public_repos' user_data.json)
          echo "public_repos=$PUBLIC_REPOS" >> $GITHUB_OUTPUT
          echo "Public repositories: $PUBLIC_REPOS"
      
      - name: Calculate streak data from commits
        id: streak-calc
        run: |
          echo "=== Calculating Streak Data for MFaheemS ==="
          
          # Get all commit dates from this repository (YYYY-MM-DD format) sorted
          git log --all --author="MFaheemS" --format="%ad" --date=short | sort -u > commit_dates.txt
          
          # Also try to get commits from other common email patterns
          git log --all --author-email="@" --format="%ad" --date=short | sort -u >> commit_dates.txt
          
          # Remove duplicates and sort
          sort -u commit_dates.txt -o commit_dates.txt
          
          echo "Total unique commit dates found: $(wc -l < commit_dates.txt)"
          
          # Calculate current streak (consecutive days from today backwards)
          CURRENT_STREAK=0
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          
          echo "Checking for commits starting from: $CURRENT_DATE"
          
          while true; do
            if grep -q "^$CURRENT_DATE$" commit_dates.txt; then
              CURRENT_STREAK=$((CURRENT_STREAK + 1))
              echo "‚úì Found commit on $CURRENT_DATE (streak: $CURRENT_STREAK)"
              CURRENT_DATE=$(date -u -d "$CURRENT_DATE -1 day" +%Y-%m-%d 2>/dev/null || date -u -v-1d -j -f "%Y-%m-%d" "$CURRENT_DATE" +%Y-%m-%d 2>/dev/null)
            else
              echo "‚úó No commit on $CURRENT_DATE - streak ends"
              break
            fi
            
            # Safety limit
            if [ $CURRENT_STREAK -gt 365 ]; then
              echo "Reached safety limit of 365 days"
              break
            fi
          done
          
          # Calculate longest streak
          LONGEST_STREAK=0
          TEMP_STREAK=0
          PREV_DATE=""
          
          echo "Calculating longest streak..."
          
          while IFS= read -r commit_date; do
            if [ -z "$PREV_DATE" ]; then
              TEMP_STREAK=1
            else
              # Calculate days difference between consecutive dates
              DAYS_DIFF=$(( ( $(date -u -d "$commit_date" +%s 2>/dev/null || date -u -j -f "%Y-%m-%d" "$commit_date" +%s) - $(date -u -d "$PREV_DATE" +%s 2>/dev/null || date -u -j -f "%Y-%m-%d" "$PREV_DATE" +%s) ) / 86400 ))
              
              if [ $DAYS_DIFF -eq 1 ]; then
                TEMP_STREAK=$((TEMP_STREAK + 1))
              else
                TEMP_STREAK=1
              fi
            fi
            
            if [ $TEMP_STREAK -gt $LONGEST_STREAK ]; then
              LONGEST_STREAK=$TEMP_STREAK
            fi
            
            PREV_DATE=$commit_date
          done < commit_dates.txt
          
          # Get total contributions (total commits in this repo)
          TOTAL_CONTRIBUTIONS=$(git rev-list --all --count)
          
          echo "current_streak=$CURRENT_STREAK" >> $GITHUB_OUTPUT
          echo "longest_streak=$LONGEST_STREAK" >> $GITHUB_OUTPUT
          echo "total_contributions=$TOTAL_CONTRIBUTIONS" >> $GITHUB_OUTPUT
          
          echo "=============================="
          echo "üìä Final Statistics:"
          echo "Current Streak: $CURRENT_STREAK days"
          echo "Longest Streak: $LONGEST_STREAK days"
          echo "Total Contributions: $TOTAL_CONTRIBUTIONS"
          echo "=============================="
      
      - name: Update SVG file
        run: |
          CURRENT_STREAK=${{ steps.streak-calc.outputs.current_streak }}
          LONGEST_STREAK=${{ steps.streak-calc.outputs.longest_streak }}
          TOTAL_CONTRIBUTIONS=${{ steps.streak-calc.outputs.total_contributions }}
          
          echo "=== Updating SVG for MFaheemS ==="
          echo "Current Streak: $CURRENT_STREAK"
          echo "Longest Streak: $LONGEST_STREAK"
          echo "Total Contributions: $TOTAL_CONTRIBUTIONS"
          
          # Determine streak emoji and message based on current streak
          if [ $CURRENT_STREAK -eq 0 ]; then
            STREAK_EMOJI="üí§"
            STREAK_MESSAGE="Start your streak today!"
          elif [ $CURRENT_STREAK -lt 7 ]; then
            STREAK_EMOJI="üî•"
            STREAK_MESSAGE="Keep it going!"
          elif [ $CURRENT_STREAK -lt 30 ]; then
            STREAK_EMOJI="‚ö°"
            STREAK_MESSAGE="You're on fire!"
          elif [ $CURRENT_STREAK -lt 100 ]; then
            STREAK_EMOJI="üåü"
            STREAK_MESSAGE="Amazing streak!"
          else
            STREAK_EMOJI="üëë"
            STREAK_MESSAGE="Legendary streak!"
          fi
          
          # Update the SVG file
          cat > streak.svg << EOF
          <svg width="495" height="195" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#1a1b27;stop-opacity:1"/>
                <stop offset="100%" style="stop-color:#2d1b69;stop-opacity:1"/>
              </linearGradient>
            </defs>
            <rect width="495" height="195" rx="10" fill="url(#grad1)"/>
            <rect width="495" height="195" rx="10" fill="none" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="247.5" y="30" font-family="Segoe UI,Arial,sans-serif" font-size="18" font-weight="bold" fill="#70a5fd" text-anchor="middle">MFaheemS's Contribution Streak</text>
            <text x="247.5" y="55" font-family="Segoe UI,Arial,sans-serif" font-size="12" fill="#9ca3af" text-anchor="middle">$STREAK_MESSAGE</text>
            <line x1="40" y1="70" x2="455" y2="70" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="80" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#70a5fd" text-anchor="middle">$CURRENT_STREAK</text>
            <text x="80" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Current Streak</text>
            <text x="80" y="160" font-family="Arial" font-size="24" text-anchor="middle">$STREAK_EMOJI</text>
            <line x1="165" y1="85" x2="165" y2="175" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="247.5" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#a78bfa" text-anchor="middle">$LONGEST_STREAK</text>
            <text x="247.5" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Longest Streak</text>
            <text x="247.5" y="160" font-family="Arial" font-size="24" text-anchor="middle">üèÜ</text>
            <line x1="330" y1="85" x2="330" y2="175" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
            <text x="415" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#34d399" text-anchor="middle">$TOTAL_CONTRIBUTIONS</text>
            <text x="415" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Total Contributions</text>
            <text x="415" y="160" font-family="Arial" font-size="24" text-anchor="middle">üìä</text>
          </svg>
          EOF
          
          echo "‚úÖ SVG file updated successfully"
      
      - name: Debug - Check for changes
        run: |
          echo "=== Git Status ==="
          git status
          echo "=================="
          
          if git diff --quiet; then
            echo "‚ö†Ô∏è  No changes detected"
          else
            echo "‚úÖ Changes detected:"
            git diff streak.svg | head -20
          fi
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "=== Committing Changes ==="
            git add streak.svg
            git commit -m "chore: update streak data for MFaheemS [skip ci]" || true
            
            echo "Attempting to push changes..."
            git push origin main || git push origin master || {
              echo "Push failed, retrying with pull first..."
              git pull origin main --rebase || git pull origin master --rebase
              git push origin main || git push origin master
            }
            echo "‚úÖ Changes pushed successfully"
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi
      
      - name: Debug - Final status
        if: always()
        run: |
          echo "=== Final Workflow Status ==="
          echo "Workflow completed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "GitHub User: MFaheemS"
          echo "Current Streak: ${{ steps.streak-calc.outputs.current_streak }} days"
          echo "Longest Streak: ${{ steps.streak-calc.outputs.longest_streak }} days"
          echo "Total Contributions: ${{ steps.streak-calc.outputs.total_contributions }}"
          echo "============================="
