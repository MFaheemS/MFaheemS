name: Update GitHub Streak Badge

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-streak:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Generate Streak SVG
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            const fs = require('fs');
            
            const username = 'MFaheemS';
            
            function getContributions() {
              return new Promise((resolve, reject) => {
                https.get(`https://github-contributions-api.jogruber.de/v4/${username}`, (res) => {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => resolve(JSON.parse(data)));
                }).on('error', reject);
              });
            }
            
            function calculateStreaks(contributions) {
              let currentStreak = 0;
              let longestStreak = 0;
              let tempStreak = 0;
              let totalContributions = 0;
              const allDates = [];
              
              Object.values(contributions.contributions).forEach(year => {
                Object.entries(year).forEach(([date, count]) => {
                  totalContributions += count;
                  if (count > 0) allDates.push(date);
                });
              });
              
              allDates.sort().reverse();
              const today = new Date().toISOString().split('T')[0];
              const todayDate = new Date(today);
              
              for (let i = 0; i < 365; i++) {
                const checkDate = new Date(todayDate);
                checkDate.setDate(checkDate.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
                if (allDates.includes(dateStr)) {
                  currentStreak++;
                } else {
                  break;
                }
              }
              
              allDates.sort();
              for (let i = 0; i < allDates.length; i++) {
                if (i === 0) {
                  tempStreak = 1;
                } else {
                  const prevDate = new Date(allDates[i - 1]);
                  const currDate = new Date(allDates[i]);
                  const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
                  if (diffDays === 1) {
                    tempStreak++;
                  } else {
                    longestStreak = Math.max(longestStreak, tempStreak);
                    tempStreak = 1;
                  }
                }
              }
              longestStreak = Math.max(longestStreak, tempStreak);
              
              return { currentStreak, longestStreak, totalContributions };
            }
            
            function createSVG(username, current, longest, total) {
              let emoji = 'ğŸ”¥';
              let status = 'Keep it up!';
              if (current === 0) {
                emoji = 'ğŸ’¤';
                status = 'Start your streak today!';
              } else if (current >= 30) {
                emoji = 'âš¡';
                status = 'Incredible streak!';
              } else if (current >= 7) {
                emoji = 'ğŸ”¥';
                status = 'On fire!';
              }
              
              return `<svg width="495" height="195" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#1a1b27;stop-opacity:1"/>
                  <stop offset="100%" style="stop-color:#2d1b69;stop-opacity:1"/>
                </linearGradient>
              </defs>
              <rect width="495" height="195" rx="10" fill="url(#grad1)"/>
              <rect width="495" height="195" rx="10" fill="none" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
              <text x="247.5" y="30" font-family="Segoe UI,Arial,sans-serif" font-size="18" font-weight="bold" fill="#70a5fd" text-anchor="middle">${username}'s Contribution Streak</text>
              <text x="247.5" y="55" font-family="Segoe UI,Arial,sans-serif" font-size="12" fill="#9ca3af" text-anchor="middle">${status}</text>
              <line x1="40" y1="70" x2="455" y2="70" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
              <text x="80" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#70a5fd" text-anchor="middle">${current}</text>
              <text x="80" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Current Streak</text>
              <text x="80" y="160" font-family="Arial" font-size="24" text-anchor="middle">${emoji}</text>
              <line x1="165" y1="85" x2="165" y2="175" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
              <text x="247.5" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#a78bfa" text-anchor="middle">${longest}</text>
              <text x="247.5" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Longest Streak</text>
              <text x="247.5" y="160" font-family="Arial" font-size="24" text-anchor="middle">ğŸ†</text>
              <line x1="330" y1="85" x2="330" y2="175" stroke="rgba(112,165,253,0.2)" stroke-width="1"/>
              <text x="415" y="110" font-family="Segoe UI,Arial,sans-serif" font-size="32" font-weight="bold" fill="#34d399" text-anchor="middle">${total}</text>
              <text x="415" y="135" font-family="Segoe UI,Arial,sans-serif" font-size="14" fill="#9ca3af" text-anchor="middle">Total Contributions</text>
              <text x="415" y="160" font-family="Arial" font-size="24" text-anchor="middle">ğŸ“Š</text>
              </svg>`;
            }
            
            const data = await getContributions();
            const stats = calculateStreaks(data);
            console.log('Current:', stats.currentStreak, 'Longest:', stats.longestStreak, 'Total:', stats.totalContributions);
            const svg = createSVG(username, stats.currentStreak, stats.longestStreak, stats.totalContributions);
            fs.writeFileSync('github-streak.svg', svg);
            
      - name: Commit changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add github-streak.svg
          git diff --staged --quiet || git commit -m "Update streak badge"
          git push
